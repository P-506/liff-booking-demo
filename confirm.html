<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</title>

  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <link rel="stylesheet" href="style.css" />
</head>
<body>

  <header class="header">
    <h1>‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</h1>
    <div class="progress">
      <div class="progress-bar" style="width:100%"></div>
    </div>
  </header>

  <main class="content">
    <div class="summary-box">
      <div class="row">
        <span class="label">‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</span>
        <span class="value" id="service">-</span>
      </div>
      <div class="row">
        <span class="label">‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà</span>
        <span class="value" id="area">-</span>
      </div>
      <div class="row">
        <span class="label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</span>
        <span class="value" id="date">-</span>
      </div>
      <div class="row">
        <span class="label">‡πÄ‡∏ß‡∏•‡∏≤</span>
        <span class="value" id="slot">-</span>
      </div>
    </div>
  </main>

  <footer class="footer">
    <button class="secondary" id="backBtn">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
    <button id="confirmBtn">‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</button>
  </footer>

<script>
  /* ===============================
     CONFIG
  =============================== */
  const LIFF_ID = "2008867980-fq1KwxaY";
  const API_URL = "https://script.google.com/macros/s/AKfycbyAd7m5oded-4pxXmBgMwBHMZ8l2CHihz5XgEX7_vK6Si95ySOuaa0NIP17hMNN2NlD/exec"; 
  // ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: https://script.google.com/macros/s/AKfycbxxxx/exec

  /* ===============================
     INIT LIFF
  =============================== */
  liff.init({ liffId: LIFF_ID }).catch(err => {
    console.error("LIFF init error", err);
  });

  /* ===============================
     LOAD DATA FROM localStorage
  =============================== */
  const serviceType = localStorage.getItem("service_type");
  const area = localStorage.getItem("area");
  const date = localStorage.getItem("date");
  const slot = localStorage.getItem("slot");
  const slotLabel = localStorage.getItem("slot_label");

  // ‡∏ñ‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö ‚Üí ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å
  if (!serviceType || !area || !date || !slot || !slotLabel) {
    alert("‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà");
    window.location.href = "index.html";
  }

  /* ===============================
     MAP ‡∏Ñ‡πà‡∏≤‡πÉ‡∏´‡πâ‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢
  =============================== */
  const serviceMap = {
    one_time: "‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡∏£‡∏≤‡∏¢‡∏Ñ‡∏£‡∏±‡πâ‡∏á",
    monthly: "‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô"
  };

  const areaMap = {
    bangkok: "‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û",
    metro: "‡∏õ‡∏£‡∏¥‡∏°‡∏ì‡∏ë‡∏•"
  };

  /* ===============================
     RENDER SUMMARY
  =============================== */
  document.getElementById("service").textContent = serviceMap[serviceType];
  document.getElementById("area").textContent = areaMap[area];
  document.getElementById("date").textContent = date;
  document.getElementById("slot").textContent = slotLabel;

  /* ===============================
     BUTTON ACTIONS
  =============================== */

  // ‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
  document.getElementById("backBtn").addEventListener("click", () => {
    history.back();
  });

  // ‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
  document.getElementById("confirmBtn").addEventListener("click", async () => {
    const btn = document.getElementById("confirmBtn");
    btn.disabled = true;
    btn.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...";

    const payload = {
      service_type: serviceType,
      area: area,
      date: date,
      slot: slot
    };

    try {
      const res = await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      const result = await res.json();

      if (!result.success) {
        alert(
          result.error === "SLOT_FULL"
            ? "‚ùå ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏µ‡πâ‡πÄ‡∏ï‡πá‡∏°‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏´‡∏°‡πà"
            : "‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á"
        );
        btn.disabled = false;
        btn.textContent = "‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á";
        return;
      }

      alert("üéâ ‡∏à‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!\n‡∏£‡∏´‡∏±‡∏™‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á: " + result.booking_id);

      // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
      localStorage.clear();

      // ‡∏õ‡∏¥‡∏î LIFF
      if (liff.isInClient()) {
        liff.closeWindow();
      }

    } catch (err) {
      console.error(err);
      alert("‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ");
      btn.disabled = false;
      btn.textContent = "‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á";
    }
  });
</script>

</body>
</html>
